#
# Deploy to Azure Container Apps
# 
#

name: CD ACA

on:
  workflow_dispatch:
    inputs:  
        IMAGE_TAG:
          description: "Image tag to be deployed"
          required: true
          default: "21-04-2022.1534"

env:
  CLUSTER_NAME: srewithazure-aks-unai
  LOCATION: westeurope
  ACR_REPO: srewithazure.azurecr.io/dotnet6 
  RG: SREwithAzure
  ACA_NAME: srewithazure-containerapp
  # INGRESS_DNS_HOST: dotnet-demoapp.kube.benco.io
  # AD_CLIENT_ID: 3584ac39-1ab1-4fe6-a3dd-4b2fbedc9d7d

jobs:
  #
  # Deploy Azure Container App
  #
  deploy-azure-green:
    name: Deploy Azure Container App to Azure Resource Group
    runs-on: ubuntu-latest
    # environment:
    #   name: AKS
    #output for next job
    outputs:
      LatestRevision: ${{ steps.get-latest-aca-revision.outputs.LatestRevision }}

    steps:

    # Checkout code
    - uses: actions/checkout@main

      # Log into Azure
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get latest ACA REVISION
      uses: azure/CLI@v1
      id: get-latest-aca-revision
      with:
        azcliversion: 2.35.0
        inlineScript: |
          az config set extension.use_dynamic_install=yes_without_prompt
          LatestRevision=$(az containerapp revision list -n $ACA_NAME -g $RG --query "[?properties.trafficWeight ==\`100\`][].name" --output tsv)
          echo "LatestRevision=$LatestRevision" >> $GITHUB_ENV
          echo "::set-output name=LatestRevision::$LatestRevision"

    - name: ECHO REVISION
      run: |
        echo "LatestRevision=$LatestRevision"
        

      # Deploy Bicep file
    - name: deploy
      #if: github.event.inputs.SKIP_INFRA == 'No'
      uses: azure/arm-deploy@v1
      id: deploy
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ secrets.RESOURCE_GROUP }}
        template: deploy/bicep/container-app.bicep
        parameters: image=${{env.ACR_REPO}}:${{ github.event.inputs.IMAGE_TAG }} acrPassword=${{ secrets.ACR_PASSWORD }} existingRevisionName=${{ env.LatestRevision }} newRevisionNumber=${{ github.event.inputs.IMAGE_TAG }}
        failOnStdErr: false
    
    #echo new revision name
    - name: echo NEW revision name
      uses: azure/CLI@v1
        
      with:
        azcliversion: 2.35.0
        inlineScript: |
          newRevisionNumber=$(az containerapp revision list -n $ACA_NAME -g $RG --query '[?properties.template.containers[0].image==`${{env.ACR_REPO}}:${{ github.event.inputs.IMAGE_TAG }}`][].name' --output tsv)
          echo $newRevisionNumber

  # check GREEN deployment and witch with BLUE if working
  switch-blue-green:
    name: switch BLUE/GREEN deployment
    runs-on: ubuntu-latest
    needs: deploy-azure-green
    environment:
      name: ACA
    
    steps:

    # Checkout code
    - uses: actions/checkout@main

      # Log into Azure
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ECHO REVISION
      run: echo ${{ needs.deploy-azure-green.outputs.LatestRevision }}

    - name: Replace the BLUE/GREEN traffic and deactivate old version
      uses: azure/CLI@v1
      with:
        azcliversion: 2.35.0
        inlineScript: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az containerapp ingress traffic set --name $ACA_NAME -g $RG --traffic-weight latest=100
          az containerapp revision deactivate --revision ${{ needs.deploy-azure-green.outputs.LatestRevision }}  --resource-group $RG